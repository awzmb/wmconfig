#!/bin/sh
#
# This script automatically enables/disables the laptop's internal display
# and its touchpad/touchscreen based on the lid state.
#
# It dynamically detects the internal display name (e.g., eDP-1, DSI-1),
# so it does not need to be hardcoded.
#
# Dependencies: sway, jq

# Check for required dependency: jq
if ! command -v jq >/dev/null; then
  echo "Error: jq is not installed. Please install it to use this script." >&2
  exit 1
fi

# dynamically find the laptop's internal display name.
# we search for outputs with names containing edp, lvds, or dsi.
LAPTOP_OUTPUT=$(swaymsg -t get_outputs | jq -r '.[] | select(.name | test("eDP-|LVDS-|DSI-")) | .name' | head -n 1)

# check if we found an output. if not, exit with an error.
if [ -z "$LAPTOP_OUTPUT" ]; then
  echo "Error: Could not find a laptop display (eDP, LVDS, or DSI)." >&2
  exit 1
fi

LID_STATE_FILE="/proc/acpi/button/lid/LID0/state"

# check if the lid state file exists
if [ ! -f "$LID_STATE_FILE" ]; then
    echo "Error: Lid state file not found at $LID_STATE_FILE" >&2
    exit 1
fi

read -r LS < "$LID_STATE_FILE"

case "$LS" in
  *open)
    echo "Lid opened. Enabling $LAPTOP_OUTPUT and inputs."
    swaymsg output "$LAPTOP_OUTPUT" enable
    swaymsg input type:touchpad events enabled
    swaymsg input type:touch events enabled
    ;;
  *closed)
    echo "Lid closed. Disabling $LAPTOP_OUTPUT and inputs."
    swaymsg output "$LAPTOP_OUTPUT" disable
    swaymsg input type:touchpad events disabled
    swaymsg input type:touch events disabled
    ;;
  *)
    echo "Could not determine lid state from: $LS" >&2
    exit 1
    ;;
esac

#LAPTOP_OUTPUT="eDP-1"
#LID_STATE_FILE="/proc/acpi/button/lid/LID0/state"

#read -r LS < "$LID_STATE_FILE"

## Check if eDP-1 is the only connected display
#CONNECTED_OUTPUTS=$(swaymsg -t get_outputs --raw | grep -c '"active": true')
#ONLY_LAPTOP_OUTPUT=$(swaymsg -t get_outputs | grep -c '"name": "'"$LAPTOP_OUTPUT"'"')

#case "$LS" in
#*open)
  #swaymsg output "$LAPTOP_OUTPUT" enable
  #swaymsg input type:touchpad events enabled
  #swaymsg input type:touch events enabled
  #;;
#*closed)
  #if [ "$CONNECTED_OUTPUTS" -eq 1 ] && [ "$ONLY_LAPTOP_OUTPUT" -eq 1 ]; then
  #swaymsg output "$LAPTOP_OUTPUT" disable
  #swaymsg input type:touchpad events disabled
  #swaymsg input type:touch events disabled
  #swaylock
  #systemctl suspend
  #;;
#*)
  #echo "Could not get lid state" >&2
  #exit 1
  #;;
#esac
